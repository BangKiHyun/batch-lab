# Chapter1 배치와 스프링

## 배치 처리 장점

1. 배치 처리를 이용한 실제 처리가 시작되기 전에 필요한 정보를 미리 수집할 수 있다.
2. 자원을 더 효율적으로 활용할 수 있다.
   - 데이터 과학 분야를 예로 들어보면, 데이터 모델 처리는 크게 두 단계로 나뉜다.
   - 첫 번째 단계는 모델의 생성, 두 번째 단계는 생성된 모델을 놓고 새로운 데이터를 평가
   - 여기서 첫 번째 단계인 모델을 생성할 때 대량의 데이터를 수학적으로 집중 처리해야 하므로 시간이 많이 걸릴 수 있다. 따라서 첫 번째 단계에서는 스트리밍 시스템이 사용할 데이터 모델을 외부에서 배치 처리를 수행해 생성하면 스트리밍 시스템이 해당 결과를 실시간으로 사용하게 할 수 있다. 

</br >

## 배치 어플리케이션 개발 시 고려사항

배치 처리는 사용자가 추가로 개입하지 않아도 특정 완료 지점까지 실행될 수 있다.

- 사용성
  - 오류 처리 및 유지 보수성
  - 예로, 공통 컴포넌트를 쉽게 확장해 새로운 기능을 추가할 수 있는가?
  - 기존 컴포넌트를 변경할 때 시스템 전체에 미치는 영향을 알 수 있도록 단위 테스트가 잘 마련되어 있는가?
  - Job이 실패할 때 디버깅에 오랜 시간을 소비하지 않고, 언제, 어디서, 왜 실패했는지 알 수 있는가?
- 확장성
  - 배치가 처리할 수 있어야 하는 규모는 웬만한 웹 애플리케이션보다 큰 경우가 많다.
- 가용성
  - 배치 처리는 보통 실행하는 시간이 정해져 있다. 즉, 리소스를 언제 사용할 수 있는지 알고 있는 상태에서 주어진 시간에 Job이 실행되도록 예약한다.
  - 예로, 계좌 잔액을 계산할 때 펀드의 종가를 사용하려면 주식 시장이 마감된 이후에 수행하도록 예약한다.
  - 허용된 시간 내에 Job을 실행함으로써 다른 시스템에 영향을 미치지 않게 할 수 있도록 고려해야 한다.
- 보안
  - 일반적으로 배치의 보안은 시스템 해킹 및 침입에 중심을 두고있지 않다.
  - 민감한 데이터베이스 필드는 암호화 되어있는가?
  - 실수로 개인 정보를 로그로 남기지 않는가?

</br >

## 자바 및 스프링으로 배치를 처리하는데 이점

- 유지보수성
  - 배치처리는 일반적으로 다른 애플리케이션 코드보다 수명이 길다.
  - 외부에서 배치 코드를 볼 수 없으며, 배치 처리가 수행한 결과를 사용한다. 그러므로 큰 위험 없이 수정할 수 있도록 코드를 작성해야 한다.
  - 스프링 프레임워크는 테스트 용이성, 추상화 등 여러 이점을 얻을 수 있도록 설계되었다.
- 유연성
  - 메인프레임이나 C++/UNIX 방식은 배포를 위한 JVM의 유연성과 스프링 배치의 기능들을 제공하지 않는다.
  - Java를 사용하면 코드를 공유할 수 있다. POJO를 통해 특정 로직을 웹 애플리케이션이나 배치 처리에 사용할 수 있다.
- 비용
  - 소프트웨어 프로젝트를 진행하면 거의 대부분 하드웨어, 소프트웨어 라이선스, 급여 등 여러 비용이 발생한다. 하지만 스프링 배치는 클라우드 리로스와 오픈소스 프레임워크를 사용하여 비용면에서 효율적이다.

</br >

## 스프링 배치 사용 사례

### ETL(추출, 변환, 적재)

- 스프링 배치의 청크 기반 처리 및 확장 기능은 ETL 패턴에 적합하다.

### 데이터 마이그레이션

- 데이터 마이그레이션 작업시 무결정 제어 기능이 빠진 일회성 솔루션을 만들 수 있다.
- 하지만 스프링 배치를 사용하면 데이터 마이그레이션을 수행할 대 당연히 포함해야 할 기능 즉, 커밋 횟수 측정이나 롤백 기능 등을 제공한다.

### 병렬 처리

- 스프링 배치는 멀티 코어, 멀티 서버에 처리를 분산하는 기능을 제공한다.
- 웹 애플리케이션에서 사용하는 것과 동일한 객체 및 데이터 소스에 접근하는 기능을 제공한다.

### 워크로드 조정

- Spring Cloud Data Flow와 스프링 배치를 사용한 Composed Task 처리 등을 통해 태스크를 조정할 수 있다.

</br >

## 스프링 배치 아키텍처

![image](https://user-images.githubusercontent.com/43977617/135317684-549ab94c-85d7-4576-8a36-a6fb926bb0e4.png)

### Application Layer

- 배치 처리 구축에 사용되는 모든 사용자 코드 및 구성. 즉, 개발자가 작성한 코드
- 업무 로직, 서비스. Job 구조화 등이 포함
- Application Layer는 최상위에 있는 것이 아니라, 다른 두 레이어인 Core와 Infrastructure를 감싸고 있다. (주로 Core와 상호작용 함)

### Core Layer

- 배치 영역을 구성하는 실질적인 여러 컴포넌트로 이뤄짐
- 즉, Job, Step 인터페이스, JobLauncher, JobParameters 등이 있다.

### Infrastructure Layer

- 파일, 데이터베이스 등 I/O 다룬다.
- Job 수행 실패 시 후 처리를 다룬다.

</br >

## Job 정의

- Job은 중단이나 상호작용 없이 처음부터 끝까지 실행되는 처리
- Job은 여러 개의 Step이 모여 이뤄질 수 있다.
- 각 Step에는 과련된 입출력이 있을 수 있으며, Step이 실패했을 때 반복 실행할 수도 있고 못할 수도 있다.
- Job의 Flow는 조건부일 수 있다.
  - 예로, 수익을 계산하는 Step이 100$ 이상의 수익을 반환할 때만 보너스 Step을 실행

